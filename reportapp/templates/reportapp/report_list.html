{% extends 'base.html' %}

{% block content %}
<div class="container"></div>
    <h1 class="my-4">æ—¥å ±ä¸€è¦§</h1>

    <form method="get" class="mb-4">
        <div class="d-flex flex-wrap align-items-end gap-2">
            <div>
                æŠ•ç¨¿æ—¥ï¼š
                {{ form.data }}
            </div>
    
            <div>
                æŠ•ç¨¿è€…ï¼š
                {{ form.author }}
            </div>

            <div>
                <select name="order" class="form-select">
                    <option value="">æ–°è¦æ—¥å ±é †</option>
                    <option value="old">ä½œæˆæ—¥é †</option>
                    <option value="like">ã„ã„ã­é †</option>
                </select>
            </div>
    
            <div>
                <button type="submit" class="btn btn-outline-primary">æ¤œç´¢</button>
            </div>
        </div>
    </form>    

    <div class="row">
    {% for report in report_list %}
    <div class="col-md-12 mb-4">
        <div class="card shadow-sm">
        <div class="card-body">
            <h5 class="card-title">{{ report.data }} - {{ report.author.username }}</h5>

            <p><strong>æ¥­å‹™å†…å®¹ï¼š</strong> {{ report.content|linebreaksbr }}</p>
            <p><strong>æŒ¯ã‚Šè¿”ã‚Šï¼š</strong> {{ report.comment|linebreaksbr }}</p>

            <p><strong>åˆè¨ˆï¼š</strong><span id="like-count-{{ report.pk }}">{{ report.likes.count }}</span>ã„ã„ã­</p>

            <div class="d-flex flex-wrap gap-2">
                <button class="btn like-button 
                {% if user in report.likes.all %}
                    btn-outline-danger
                {% else %}
                    btn-outline-primary
                {% endif %}"
                data-report-id="{{ report.pk }}">
                
                {% if user in report.likes.all %}
                    ğŸ‘å–æ¶ˆ
                {% else %}
                    ğŸ‘
                {% endif %}
            </button>

            <a href="{% url 'reportapp:report_detail' report.pk %}" class="btn btn-outline-info text-black">è©³ç´°</a>
            <a href="{% url 'reportapp:report_comment' report.pk %}" class="btn btn-outline-info text-black">ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ </a>

            {% if user == report.author or user.is_superuser %}
                <a href="{% url 'reportapp:report_update' report.pk %}" class="btn btn-outline-info text-black">ç·¨é›†</a>
                <a href="{% url 'reportapp:report_delete' report.pk %}" class="btn btn-outline-danger text-black">å‰Šé™¤</a>
            {% endif %}
            </div>

        </div>
        </div>
    </div>
    {% empty %}
    <p>ã¾ã æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
    {% endfor %}
    <script>
        // --- CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾— ---
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');
        
        // --- ã„ã„ã­ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ ---
        document.querySelectorAll('.like-button').forEach(button => {
            button.addEventListener('click', function() {
                const reportId = this.dataset.reportId;  // â† ã“ã“ã§ãƒœã‚¿ãƒ³ã®IDã‚’å–å¾—
        
                fetch(`/reportapp/like/${reportId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({})
                })
                .then(response => response.json())
                .then(data => {
                    // ã„ã„ã­æ•°ã‚’æ›´æ–°ã™ã‚‹éƒ¨åˆ†
                    const likeCountElement = document.querySelector(`#like-count-${reportId}`);
                    if (likeCountElement) {
                        likeCountElement.innerText = data.like_count;
                    }
        
                    // ãƒœã‚¿ãƒ³ã®è¦‹ãŸç›®ã‚’æ›´æ–°
                    if (data.liked) {
                        this.classList.remove('btn-outline-primary');
                        this.classList.add('btn-outline-danger');
                        this.innerText = 'ğŸ‘å–æ¶ˆ';
                    } else {
                        this.classList.remove('btn-outline-danger');
                        this.classList.add('btn-outline-primary');
                        this.innerText = 'ğŸ‘';
                    }
                });
            });
        });
        </script>
    </div>
</div>
{% endblock %}
